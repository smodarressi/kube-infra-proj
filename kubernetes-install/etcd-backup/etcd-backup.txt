First we need the etcd-client

sudo apt install etcd-client

#its not working....
Useful Links to etcd backup

https://docs.kasten.io/latest/kanister/etcd/k8s/install.html

https://elastisys.com/backup-kubernetes-how-and-why/

https://www.shrlrn.com/practice/k8slab-322

First check cat /etc/kubernetes/manifests/etcd.yaml

/etc/kubernetes/manifests is location where kubernetes save control plane/static pods yaml file

Information from this file is required to get etcd configuration

take note of 
--advertise-client-urls
--cert-file
--peer-cert-file
--peer-key-file
--data-dir
--initial-advertise-peer-urls
--initial-cluster

# Backup certificates
sudo cp -r /etc/kubernetes/pki backup/
# Make etcd snapshot

sudo docker run --rm -v $(pwd)/backup:/backup \
    --network host \
    -v /etc/kubernetes/pki/etcd:/etc/kubernetes/pki/etcd \
    --env ETCDCTL_API=3 \
    k8s.gcr.io/etcd:3.4.13-0 \
    etcdctl --endpoints=https://127.0.0.1:2379 \
    --cacert=/etc/kubernetes/pki/etcd/ca.crt \
    --cert=/etc/kubernetes/pki/etcd/peer.crt \
    --key=/etc/kubernetes/pki/etcd/peer.key \
    snapshot save /backup/etcd-snapshot-latest.db

--network host: use host network to access 
-v $(pwd)/backup:/backup --> mount the /backup folder
--env ETCDCTL_API=3 k8s.gcr.io/etcd:3.4.13-0 --> use etcd version that was pulled with kubeadm
--endpoint --> use localhost:2379 to access the exposed etcd port 
--cert, --cacert, --key for etcd specified certificates 
etcdctl snapshot save /backup/etcd-snapshot-latest.db --> base command for creating a snapshot 

# Backup kubeadm-config (if we have a kubeadm config)
sudo cp /etc/kubeadm/kubeadm-config.yaml backup/

To simulate destruction of controlplane use kubeadm reset command. 

To restore the etcd
# Restore certificates
sudo cp -r backup/pki /etc/kubernetes/

To simulate destruction of controlplane use kubeadm reset command. 

# Restore etcd backup
sudo mkdir -p /var/lib/etcd
sudo docker run --rm \
    -v $(pwd)/backup:/backup \
    -v /var/lib/etcd:/var/lib/etcd \
    --env ETCDCTL_API=3 \
    k8s.gcr.io/etcd:3.4.3-0 \
    /bin/sh -c "etcdctl snapshot restore '/backup/etcd-snapshot-latest.db' ; mv /default.etcd/member/ /var/lib/etcd/"

# Restore kubeadm-config
sudo mkdir /etc/kubeadm
sudo cp backup/kubeadm-config.yaml /etc/kubeadm/

# Initialize the master with backup
sudo kubeadm init --ignore-preflight-errors=DirAvailable--var-lib-etcd 

